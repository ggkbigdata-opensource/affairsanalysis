<!DOCTYPE html>
<html style="height: 100%;">
<head>
 <meta charset="utf-8">
    <title>广州市政府服务热线</title>
    <link id="bs-css" href="./css/bootstrap-cerulean.min.css" rel="stylesheet">

    <link href="./css/charisma-app.css" rel="stylesheet">
    <link href='./bower_components/fullcalendar/dist/fullcalendar.css' rel='stylesheet'>
    <link href='./bower_components/fullcalendar/dist/fullcalendar.print.css' rel='stylesheet' media='print'>
    <link href='./bower_components/chosen/chosen.min.css' rel='stylesheet'>
    <link href='./bower_components/colorbox/example3/colorbox.css' rel='stylesheet'>
    <link href='./bower_components/responsive-tables/responsive-tables.css' rel='stylesheet'>
    <link href='./bower_components/bootstrap-tour/build/css/bootstrap-tour.min.css' rel='stylesheet'>
    <link href='./css/jquery.noty.css' rel='stylesheet'>
    <link href='./css/noty_theme_default.css' rel='stylesheet'>
    <link href='./css/elfinder.min.css' rel='stylesheet'>
    <link href='./css/elfinder.theme.css' rel='stylesheet'>
    <link href='./css/jquery.iphone.toggle.css' rel='stylesheet'>
    <link href='./css/uploadify.css' rel='stylesheet'>
    <link href='./css/animate.min.css' rel='stylesheet'>
    

    <!-- jQuery -->
    <script src="./bower_components/jquery/jquery.min.js"></script>
    <link type="text/css" rel="stylesheet" href="./js/hotTrendAnalysisChartJs/styles.css">
	<link type="text/css" rel="stylesheet" href="./js/hotTrendAnalysisChartJs/jquery-ui.min.css">
	<script src="./js/lib/baidu/echarts.min.js"></script>
	
    <link href='./css/bootstrap-multiselect.css' rel='stylesheet'>
	<script src="./js/lib/jquery/jquery.min.js"></script>
	<script src="./js/hotTrendAnalysisChartJs/jquery-ui.js"></script>
    <script src="./js/bootstrap-datetimepicker.js"></script>
    <script src="./js/bootstrap-datetimepicker.zh-CN.js"></script>
    <link href="./css/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
    <script src="./js/bootstrap-multiselect.js"></script>
    
    <link type="text/css" rel="stylesheet" href="./js/home/styles.css">
<link rel="stylesheet" href="./js/home/tips.css">
</head>

<body>
    <!-- topbar starts -->
    <div class="navbar navbar-default" role="navigation">
        <div class="navbar-inner">
            <button type="button" class="navbar-toggle pull-left animated flip">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/affairsanalysis">
                <span>政府服务热线</span>
            </a>
            <div class="btn-group pull-right">
                <button class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    <i class="glyphicon glyphicon-user"></i><span class="hidden-sm hidden-xs"> admin</span>
                </button>
            </div>
        </div>
    </div>
<div class="ch-container">
    <div class="row" style="background-color: #ECF1F3;">
        <div class="col-sm-2 col-lg-2">
            <div class="sidebar-nav">
                <div class="nav-canvas">
                    <div class="nav-sm nav nav-stacked">
                    </div>
                    <ul class="nav nav-pills nav-stacked main-menu">
                       <li class="nav-header">诉求类</li>
                        <li><a class="ajax-link" href="/affairsanalysis"><i class="glyphicon glyphicon-home"></i><span> 首页</span></a>
                        </li>
                        <li><a class="ajax-link" href="./hotChart"><i class="glyphicon glyphicon-eye-open"></i><span> 热线分布图</span></a>
                        </li>
                        <li ><a class="ajax-link" href="./hotTrendAnalysisChart"><i class="glyphicon glyphicon-edit"></i><span> 大家都在问</span></a></li>
                        <li><a class="ajax-link" href="./traceabilityList"><i class="glyphicon glyphicon-list-alt"></i><span> 追溯来源</span></a></li>
                        <li><a class="ajax-link" href="./rankList"><i class="glyphicon glyphicon-list-alt"></i><span> 排名列表</span></a></li>
                        <li class="nav-header hidden-md">咨询类</li>
                        <li ><a class="ajax-link" href="./index_zx"><i class="glyphicon glyphicon-home"></i><span> 首页</span></a></li>
                        <li class="active"><a class="ajax-link" href="./hotTrendAnalysisChart_zx"><i class="glyphicon glyphicon-edit"></i><span> 大家都在问</span></a></li>
                        <li><a class="ajax-link" href="./traceabilityList_zx"><i class="glyphicon glyphicon-list-alt"></i><span> 追溯来源</span></a></li>
                        <li ><a class="ajax-link" href="./rankList_zx"><i class="glyphicon glyphicon-list-alt"></i><span> 排名列表</span></a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div id="content" class="col-lg-10 col-sm-10">
            <!-- content starts -->
            <div>
    <ul class="breadcrumb">
        <li>
            <a href="./index_zx">咨询类</a>
        </li>
        <li>
            <a href="./hotTrendAnalysisChart_zx">大家都在问</a>
        </li>
    </ul>
</div>
<div class="row">
<body>
    <div class="" style="margin-left: 0px;"id="trendTools">
        <div id="lTools" class="lTools sZone">
            <div id="lTools_c">
                <form id="adv_pannel" class="" autocomplete="off">
                    <div class="tabUnit" id="">
                        <div class="tabConts" style="padding-top: 8px; *z-index: 1; float: left;" >
                            <div class="tabCont tabContWord" id="">
                                <div id="compOthtime" class="compOth">
                                    <div class="comCtl">
                                        <div class="comBorderL">
                                            <span class=" rangeDate" limitb="20110101"> 
                                                <span class="icontext">时间：</span> 
                                                <span class="sltTxt" id="timeTxt">最近30天</span> 
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="compVsplit"></div>
                                <ul class="compUl hideDel" ctlname="word">
                                    <li class="compLi comCtl">
                                        <table>
                                           <tr>
											   <td style="font-weight: bold;">时间:</td>
											   <td style="width:200px">
												   <div class="input-group date form_date col-md-12" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd" onchange="changeDate()">
												      <input id = "startDate" class="form-control" size="16" type="text" value=""  readonly >
												      <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
												      <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
												  </div>
												</td>
												<td>--</td>
												<td style="width:200px">
												    <div class="input-group date form_date col-md-12" data-date="" data-date-format="yyyy-mm-dd" data-link-field="dtp_input2" data-link-format="yyyy-mm-dd" onchange="changeDate()">
												       <input id= 'endDate' class="form-control" size="16" type="text" value=""  readonly >
												       <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
												       <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
												   </div>
												</td>
												<td style="width:50px" id="subjectTD1"></td>
												<td style="font-weight: bold;" id="subjectTD2">主题词:</td>
												<td id="subjectTD3" > 
												   <select id="sel_wordName" multiple="multiple" size="5"></select>
												</td>
												<td id="wordInputTD" hidden="true">
												    <input type="text" id="wordInput" style="height:35px;width:180px" class="comWord" maxlength="50" autocomplete="off" value="">
												</td>
												<td style="width:50px"></td>
												<td>
												    <button type="button"  id="search" class="btn btn-primary" onclick="serachInfo()">查询</button>
												</td>
									         </tr>
                                        </table>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div id="mainWrap" style="background-color: #ECF1F3;">
            <div class="mainSplit" style="background-color: #ECF1F3;">
                <div class="zsClass" id="trend-wrap" style="background-color: #ECF1F3;">
                    <div class="titlBar" style="padding-bottom: 16px;" id="auto_gsid_7" >
                        <h4>指数趋势</h4>
                    </div>  
                    <div class="grpArea" style="width: 100%; overflow: hidden; position: relative; z-index: 0;" id="auto_gsid_15">
                        <div style="position: absolute; top: 0; z-index: 2; width: 100%;">
                            <div class="box-toolbar" style="right: 17px; top: 26px;">
                                <label style="line-height: 32px; cursor: default;" class="tab-circle-label">最近</label> 
                                <a class="chartselect" rel="7" href="javascript:void(0)" onclick="serachInfo(7)">7天</a> 
                                <a class="chartselect" rel="30" href="javascript:void(0)" onclick="serachInfo(30)">30天</a> 
                                <a class="chartselect" rel="90" href="javascript:void(0)" onclick="serachInfo(90)">90天</a> 
                                <a class="chartselect" rel="180" href="javascript:void(0)" onclick="serachInfo(180)">半年</a>
                            </div>
                        </div>
                        <div id="container"  style="height: 600px; _background-color: #fff;padding-top: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script type="text/javascript">
    var availableTags;
    var copIndexArr = [2,3,4,5];
    var ulIndex = 2;
    var dayIndex = 30;
    var colorArr= ["#3ec7f5","#2cc312","#e7882e","#f362a5","#b16ec2"]
    var bgColorArr = ["rgba(62, 199, 245, 0.3)","rgba(44,195,18,0.3)","rgba(231, 136, 46, 0.3)","rgba(243, 98, 165, 0.3)","rgba(177, 110, 194, 0.3)"]
    $(function(){
    	var pa = decodeURIComponent((location.search.substr(location.search.indexOf("=")+1)));
    	$("#startDate").val(GetDateStr(-7));
    	$("#endDate").val(GetDateStr(0));
    	$('.form_date').datetimepicker({
    	    language:  'zh-CN',
    	    weekStart: 1,
    	    todayBtn:  1,
    	    autoclose: 1,
    	    todayHighlight: 1,
    	    startView: 2,
    	    minView: 2,
    	    forceParse: 0
    	});
    	 $.ajax({
             url : './queryEveryoneAsk',
             type : 'post', // 数据发送方式
             data:{startDate:$("#startDate").val(),endDate:$("#endDate").val(),type:2},
             success : function(data) {
                 var selwordNameHtml ="";
                 var index = 1;
                 for(var d in data){
                	 if(selwordNameHtml==""&&(pa==""||pa==undefined)){
                		 selwordNameHtml += '<option value="'+data[d].wordName+'" selected ="selected">'+data[d].wordName+'</option>'
                	 }else{
                		 selwordNameHtml += '<option value="'+data[d].wordName+'">'+data[d].wordName+'</option>'
                	 }
                 }
                 selwordNameHtml += '<option value="其他">其他</option>';
                 $("#sel_wordName").html(selwordNameHtml); 
                 $('#sel_wordName').multiselect({
                	 onChange: function(option, checked,select) {
                		 if(option.val()=="其他"){
                			 if(checked){
                				 $.ajax({
                		             url : './queryAllSubject',
                		             type : 'post', // 数据发送方式
                		             data:{startDate:$("#startDate").val(),endDate:$("#endDate").val(),type:2},
                		             success : function(data) {
                		            	 availableTags = data;
                		            	 $('#wordInputTD').show();
                                         $("#wordInput").autocomplete({
                                             source: availableTags
                                          });
                		             }
                				 });
                				
                			 }else{
                                 $('#wordInputTD').hide();
                                 $('#wordInput').val("");
                             }
                		 }
                         var selectedOptions = $('#sel_wordName option:selected');
                         if (selectedOptions.length >= 5) {
                             var nonSelectedOptions = $('#sel_wordName option').filter(function() {
                                 return !$(this).is(':selected');
                             });
          
                             var dropdown = $('#sel_wordName').siblings('.multiselect-container');
                             nonSelectedOptions.each(function() {
                                 var input = $('input[value="' + $(this).val() + '"]');
                                 input.prop('disabled', true);
                                 input.parent('li').addClass('disabled');
                             });
                         }
                         else {
                             var dropdown = $('#sel_wordName').siblings('.multiselect-container');
                             $('#sel_wordName option').each(function() {
                                 var input = $('input[value="' + $(this).val() + '"]');
                                 input.prop('disabled', false);
                                 input.parent('li').addClass('disabled');
                             });
                         }
                     },
                     maxHeight: 400,
                     enableFiltering: true,
                 })
                 $('#sel_wordName').multiselect('select', [decodeURIComponent((location.search.substr(location.search.indexOf("=")+1)))]);
                 
                 var myDate = new Date();
                 var newData = myDate.getFullYear()+"-"+(myDate.getMonth()+1)+"-"+myDate.getDate(); 
                 var wordArr = $('#sel_wordName').val();
                 var word = "";
                 if(wordArr!=null&&wordArr.length>0){
                     for(var w in wordArr){
                         if(word==""){
                             word += wordArr[w];
                         }else{
                             word += "," + wordArr[w];
                         }
                     }
                 }
                 $.ajax({
                     url : './queryHotTrendAnalysisChart',
                     type : 'post', // 数据发送方式
                     data:{startDate:$('#startDate').val(),endDate:$('#endDate').val(),wordList:word,type:2},
                     success : function(data) {
                         var wordList = [];
                         var yearList = [];
                         var chartData =[];
                         for(var i=30;i>=0;i--){
                             yearList.push(GetDateStr(-i));
                         }
                         for(var d in data){
                             if(!isExist(wordList,data[d].wordName)){
                                 wordList.push(data[d].wordName)
                             }
                         }
                         for(var w in wordList){
                             var dataArr = [];
                             for(var y in yearList){
                                 var isTrue = false;
                                     for(var d in data){
                                         if(wordList[w]==data[d].wordName&&yearList[y]==data[d].time){
                                         if(yearList[y]==data[d].time){
                                             isTrue = true;
                                             break;
                                         }
                                     }
                                 }
                                 if(isTrue){
                                     dataArr.push(data[d].sumCount);
                                 }else{
                                     dataArr.push('');
                                 }
                             }
                             var chartArr =  {
                                     name:wordList[w],
                                     type:'line',
                                     smooth:true,
                                     symbol: 'none',
                                     sampling: 'average',
                                     itemStyle: {
                                         normal: {
                                              color: '#3ec7f5'
                                         }
                                     },
                                    areaStyle: {
                                        normal: {
                                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [ {
                                                offset: 1,
                                                color: 'rgba(62, 199, 245, 0.3)'
                                            }])
                                        }
                                     },
                                     data:dataArr
                                 };
                             chartData.push(chartArr);
                         }
                         optionList(wordList,yearList,chartData)
                         chartInit();
                     }
                  });
             }
         });
    });
    
    function changeDate(){
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        var wordName = $('#sel_wordName').val();
        if(startDate==""){
        	alert("请选择开始时间!")
        	return
        }
        if(endDate==""){
            alert("请选择结束时间!")
            return
        }
        if(startDate>endDate){
            alert("开始时间不能大于结束时间!")
            return
        }
        if(wordName==""){
        	alert("请选择主题词!")
        	return
        }
        $("#askHtml").html("");
        $('#wordInputTD').hide();
        $('#wordInput').val("");
        if(startDate!=""&&endDate!=""){
        	$.ajax({
                url : './queryAllSubject',
                type : 'post', // 数据发送方式
                data:{startDate:$("#startDate").val(),endDate:$("#endDate").val(),type:2},
                success : function(data) {
                    availableTags = data;
                    $("#wordInput").autocomplete({
                        source: availableTags
                     });
                }
            });
            $.ajax({
            url : './queryEveryoneAsk',
            type : 'post', // 数据发送方式
            data :{startDate:startDate,endDate:endDate,type:2},
            success : function(data) {
                var selwordNameHtml ="";
                var index = 1;
                for(var d in data){
                    selwordNameHtml += '<option value="'+data[d].wordName+'">'+data[d].wordName+'</option>'
                }
                selwordNameHtml += '<option value="其他">其他</option>';
                $("#sel_wordName").html(selwordNameHtml); 
                $('#sel_wordName').multiselect('destroy')
                $('#sel_wordName').multiselect({
                    onChange: function(option, checked) {
                    	if(option.val()=="其他"){
                            if(checked){
                                $.ajax({
                                    url : './queryAllSubject',
                                    type : 'post', // 数据发送方式
                                    data:{startDate:$("#startDate").val(),endDate:$("#endDate").val(),type:2},
                                    success : function(data) {
                                        availableTags = data;
                                        $('#wordInputTD').show();
                                        $("#wordInput").autocomplete({
                                            source: availableTags
                                         });
                                    }
                                });
                               
                            }else{
                                $('#wordInputTD').hide();
                                $('#wordInput').val("");
                            }
                        }
                        var selectedOptions = $('#sel_wordName option:selected');
                        if (selectedOptions.length >= 5) {
                            var nonSelectedOptions = $('#sel_wordName option').filter(function() {
                                return !$(this).is(':selected');
                            });
         
                            var dropdown = $('#sel_wordName').siblings('.multiselect-container');
                            nonSelectedOptions.each(function() {
                                var input = $('input[value="' + $(this).val() + '"]');
                                input.prop('disabled', true);
                                input.parent('li').addClass('disabled');
                            });
                        }
                        else {
                            // Enable all checkboxes.
                            var dropdown = $('#sel_wordName').siblings('.multiselect-container');
                            $('#sel_wordName option').each(function() {
                                var input = $('input[value="' + $(this).val() + '"]');
                                input.prop('disabled', false);
                                input.parent('li').addClass('disabled');
                            });
                        }
                    },
                    maxHeight: 400,
                   /*  dropUp: true */
                    enableFiltering: true,
                })
            }
        });
        }else{
            return;
        }
    }
    
    function GetDateStr(AddDayCount,date) 
    { 
    	var dd;
        if(date!=""&&date!=undefined){
            dd = new Date(date.replace(/-/g, "/")); 
        }else{
            dd = new Date(); 
        }
        dd.setDate(dd.getDate()+AddDayCount);//获取AddDayCount天后的日期 
        var y = dd.getFullYear(); 
        var m = (dd.getMonth()+1)<10?"0"+(dd.getMonth()+1):(dd.getMonth()+1);//获取当前月份的日期，不足10补0
        var d = dd.getDate()<10?"0"+dd.getDate():dd.getDate(); //获取当前几号，不足10补0
        return y+"-"+m+"-"+d; 
    }
    function isExist(arr,value){
        if(arr.length>0){
            for(var a in arr){
                if(arr[a]==value){
                    return true;
                }
            }
        }
        return false;
    }
    function chartInit(){
        var myChart = echarts.init(document.getElementById('container'));
        myChart.setOption(option);
    }
    var option;
    function optionList(wordList,yearList,data){
        option = {
            tooltip: {
                trigger: 'axis',
                position: function (pt) {
                    return [pt[0], '10%'];
                }
            },
            legend: {
                 data:wordList
            },
            backgroundColor: '#ECF1F3',
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: yearList
            },
            yAxis: {
                type: 'value',
                boundaryGap: [0, '5%']
            },
            dataZoom: [{
                type: 'inside',
                start: 0,
                end: 100,
            }, {
                start:0,
                end: 100
            }],
            series: data
        };
    }
   
    function serachInfo(day){
    	var st = "";
    	if(day!=""&&day!=undefined){
    		dayIndex = day;
    		st = GetDateStr(day*-1,$('#endDate').val());
    		$('#startDate').val(st);
    		$("#timeTxt").text("最近"+day+"天")
    	}else{
    		st = $('#startDate').val();
    	}
    	
    	
    	var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        var wordArr = $('#sel_wordName').val();
        if(startDate==""){
            alert("请选择开始时间!")
            return
        }
        if(endDate==""){
            alert("请选择结束时间!")
            return
        }
        if(startDate>endDate){
            alert("开始时间不能大于结束时间!")
            return
        }
        if(wordArr==null){
            alert("请选择主题词!")
            return
        }
        var word = "";
    	if(wordArr!=null&&wordArr.length>0){
    		for(var w in wordArr){
    			if(word==""){
    				word += wordArr[w];
    			}else{
    				word += "," + wordArr[w];
    			}
    		}
    	}
    	if($('#wordInput').val()!=undefined&&$('#wordInput').val()!=""){
    		if(word!=""&&word!=undefined){
    			word += ","+$('#wordInput').val();
    		}
    	}
        $.ajax({
            url : './queryHotTrendAnalysisChart',
            type : 'post', // 数据发送方式
            data:{startDate:st,endDate:$('#endDate').val(),wordList:word,type:2},
            success : function(data) {
                var wordList = [];
                var yearList = [];
                var chartData =[];
                for(var i=dayIndex;i>=0;i--){
                    yearList.push(GetDateStr(-i,$('#endDate').val()));
                }
                for(var d in data){ 
                    if(!isExist(wordList,data[d].wordName)){
                        wordList.push(data[d].wordName)
                    }
                }
                for(var w in wordList){
                    var dataArr = [];
                    for(var y in yearList){
                        var isTrue = false;
                            for(var d in data){
                                if(wordList[w]==data[d].wordName&&yearList[y]==data[d].time){
                                if(yearList[y]==data[d].time){
                                    isTrue = true;
                                    break;
                                }
                            }
                        }
                        if(isTrue){
                            dataArr.push(data[d].sumCount);
                        }else{
                            dataArr.push('');
                        }
                    }
                    var chartArr =  {
                            name:wordList[w],
                            type:'line',
                            smooth:true,
                            symbol: 'none',
                            sampling: 'average',
                            itemStyle: {
                                normal: {
                                     color: colorArr[w]
                                }
                            },
                           areaStyle: {
                               normal: {
                                   color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [ {
                                       offset: 1,
                                       color: bgColorArr[w]
                                   }])
                               }
                            },
                            data:dataArr
                        };
                    chartData.push(chartArr);
                }
                optionList(wordList,yearList,chartData)
                chartInit();
            }
         });
    }
</script>
</body>
</div>

</div>
</div>
</div>
<script src="./bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<!-- library for cookie management -->
<script src="./js/jquery.cookie.js"></script>
<!-- calender plugin -->
<script src='./bower_components/moment/min/moment.min.js'></script>
<script src='./bower_components/fullcalendar/dist/fullcalendar.min.js'></script>
<!-- data table plugin -->
<script src='./js/jquery.dataTables.min.js'></script>

<!-- select or dropdown enhancer -->
<script src="./bower_components/chosen/chosen.jquery.min.js"></script>
<!-- plugin for gallery image view -->
<script src="./bower_components/colorbox/jquery.colorbox-min.js"></script>
<!-- notification plugin -->
<script src="./js/jquery.noty.js"></script>
<!-- library for making tables responsive -->
<script src="./bower_components/responsive-tables/responsive-tables.js"></script>
<!-- tour plugin -->
<script src="./bower_components/bootstrap-tour/build/js/bootstrap-tour.min.js"></script>
<!-- star rating plugin -->
<script src="./js/jquery.raty.min.js"></script>
<!-- for iOS style toggle switch -->
<script src="./js/jquery.iphone.toggle.js"></script>
<!-- autogrowing textarea plugin -->
<script src="./js/jquery.autogrow-textarea.js"></script>
<!-- multiple file upload plugin -->
<script src="./js/jquery.uploadify-3.1.min.js"></script>
<!-- history.js for cross-browser state change on ajax -->
<script src="./js/jquery.history.js"></script>
<!-- application script for Charisma demo -->
<script src="./js/charisma.js"></script>


</body>
</html>
